// Prisma Schema для VK Automation Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int            @id @default(autoincrement())
  email           String         @unique
  passwordHash    String         @map("password_hash")
  telegramChatId  BigInt?        @map("telegram_chat_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  vkAccounts      VkAccount[]
  rules           Rule[]
  autoDisableRules AutoDisableRule[]
  sharedAccounts  VkAccountShare[] // Аккаунты, к которым есть доступ

  @@map("users")
}

model VkAccount {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  name            String         // Название аккаунта (например "Основной", "Клиент 1")
  accessToken     String         @map("access_token")
  tokenHash       String         @unique @map("token_hash") // Хеш токена для проверки дубликатов
  telegramChatId  String?        @map("telegram_chat_id") // Chat ID для уведомлений по этому кабинету
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  adAccounts      AdAccount[]
  rules           Rule[]
  autoDisableRules AutoDisableRule[]
  sharedWith      VkAccountShare[] // Пользователи, с которыми расшарен аккаунт

  @@map("vk_accounts")
}

// Таблица для шаринга VK аккаунтов между пользователями
model VkAccountShare {
  id              Int            @id @default(autoincrement())
  vkAccountId     Int            @map("vk_account_id")
  sharedWithUserId Int           @map("shared_with_user_id")
  canEdit         Boolean        @default(false) @map("can_edit") // Может редактировать правила
  createdAt       DateTime       @default(now()) @map("created_at")

  vkAccount       VkAccount      @relation(fields: [vkAccountId], references: [id], onDelete: Cascade)
  sharedWithUser  User           @relation(fields: [sharedWithUserId], references: [id], onDelete: Cascade)

  @@unique([vkAccountId, sharedWithUserId])
  @@map("vk_account_shares")
}

model AdAccount {
  id              Int            @id @default(autoincrement())
  vkAccountId     Int            @map("vk_account_id")
  vkAdAccountId   BigInt         @map("vk_ad_account_id")
  name            String?
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")

  vkAccount       VkAccount      @relation(fields: [vkAccountId], references: [id], onDelete: Cascade)
  rules           Rule[]

  @@map("ad_accounts")
}

model Rule {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  vkAccountId     Int?           @map("vk_account_id")
  name            String
  adAccountId     Int?           @map("ad_account_id")
  cplThreshold    Decimal        @default(200.00) @map("cpl_threshold") @db.Decimal(10, 2)
  minLeads        Int            @default(3) @map("min_leads")
  copiesCount     Int            @default(3) @map("copies_count")
  copyBudget      Decimal?       @map("copy_budget") @db.Decimal(10, 2) // Бюджет для копий (null = как у оригинала)

  // Тип проверки прибыльности: "cpl" (по CPL из VK Ads) или "leadstech" (реальная прибыльность через LeadsTech)
  profitabilityCheck String      @default("cpl") @map("profitability_check")

  // Период проверки в днях (для profitabilityCheck = "leadstech"): 1 = вчера, 3 = 3 дня, 7 = неделя
  periodDays      Int            @default(1) @map("period_days")

  runTime         String         @default("09:00") @map("run_time")
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  vkAccount       VkAccount?     @relation(fields: [vkAccountId], references: [id], onDelete: SetNull)
  adAccount       AdAccount?     @relation(fields: [adAccountId], references: [id], onDelete: SetNull)
  executions      RuleExecution[]

  @@map("rules")
}

model RuleExecution {
  id              Int            @id @default(autoincrement())
  ruleId          Int            @map("rule_id")
  executedAt      DateTime       @default(now()) @map("executed_at")
  groupsChecked   Int            @map("groups_checked")
  groupsMatched   Int            @map("groups_matched")
  copiesCreated   Int            @map("copies_created")
  status          String         // 'success', 'partial', 'failed'
  errorMessage    String?        @map("error_message")
  details         Json?

  rule            Rule           @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  adGroupCopies   AdGroupCopy[]

  @@map("rule_executions")
}

model AdGroupCopy {
  id                Int            @id @default(autoincrement())
  ruleExecutionId   Int            @map("rule_execution_id")
  originalAdId      BigInt         @map("original_ad_id")
  copiedAdId        BigInt         @map("copied_ad_id")
  createdAt         DateTime       @default(now()) @map("created_at")

  ruleExecution     RuleExecution  @relation(fields: [ruleExecutionId], references: [id], onDelete: Cascade)

  @@map("ad_group_copies")
}

// Правила автоматического отключения объявлений
// Новая логика: "если потрачено >= X И метрика (клики/результаты/CTR) соответствует условию"
model AutoDisableRule {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  vkAccountId     Int            @map("vk_account_id")
  name            String

  // Тип метрики для проверки: clicks, goals (результаты/лиды), ctr
  metricType      String         @map("metric_type")

  // Оператор сравнения для метрики: lt (<), lte (<=), eq (=)
  operator        String         @default("lt")

  // Пороговое значение метрики (клики < 2, результаты < 3, CTR < 0.1)
  threshold       Decimal        @db.Decimal(10, 2)

  // ГЛАВНОЕ УСЛОВИЕ: минимальный потраченный бюджет для срабатывания
  // "если потрачено >= X" - это первичное условие
  minSpent        Decimal        @default(75) @map("min_spent") @db.Decimal(10, 2)

  // Период анализа в днях (1 = сегодня, 3, 7)
  periodDays      Int            @default(1) @map("period_days")

  // Время проверки (HH:MM)
  runTime         String         @default("09:00") @map("run_time")

  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  vkAccount       VkAccount      @relation(fields: [vkAccountId], references: [id], onDelete: Cascade)
  executions      AutoDisableExecution[]

  @@map("auto_disable_rules")
}

model AutoDisableExecution {
  id              Int            @id @default(autoincrement())
  ruleId          Int            @map("rule_id")
  executedAt      DateTime       @default(now()) @map("executed_at")
  adsChecked      Int            @map("ads_checked")
  adsDisabled     Int            @map("ads_disabled")
  status          String         // 'success', 'failed'
  errorMessage    String?        @map("error_message")
  details         Json?          // Детали по каждому отключенному объявлению

  rule            AutoDisableRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@map("auto_disable_executions")
}

// Сохранённые тексты для объявлений (автозалив)
model AdText {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  name            String         // Название для удобства выбора
  title           String         // Заголовок объявления
  text            String         // Основной текст объявления
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("ad_texts")
}

// Задачи автозалива кампаний
model AutoUploadTask {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  vkAccountId     Int            @map("vk_account_id")

  // Название кампании
  campaignName    String         @map("campaign_name")

  // ID сообщества VK (куда ведём)
  groupId         BigInt         @map("group_id")
  groupName       String?        @map("group_name")

  // ID аудитории ретаргетинга (опционально)
  audienceId      BigInt?        @map("audience_id")
  audienceName    String?        @map("audience_name")

  // Текст объявления
  adTextId        Int?           @map("ad_text_id")
  adTitle         String         @map("ad_title")
  adText          String         @map("ad_text")

  // Количество креативов (= количество групп объявлений)
  creativesCount  Int            @map("creatives_count")

  // Созданная кампания
  createdCampaignId BigInt?      @map("created_campaign_id")
  createdAdGroups Json?          @map("created_ad_groups") // [{ id, name, adId }]

  // Статус
  status          String         @default("pending") // pending, uploading_creatives, creating_campaign, completed, failed
  progress        Int            @default(0)
  errorMessage    String?        @map("error_message")

  createdAt       DateTime       @default(now()) @map("created_at")
  startedAt       DateTime?      @map("started_at")
  completedAt     DateTime?      @map("completed_at")

  @@map("auto_upload_tasks")
}

// Пользовательские названия для сегментов/аудиторий VK
// VK API не предоставляет названия, поэтому храним их локально
model SegmentLabel {
  id              Int            @id @default(autoincrement())
  vkAccountId     Int            @map("vk_account_id")
  segmentId       BigInt         @map("segment_id")  // ID сегмента в VK
  name            String         // Пользовательское название
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@unique([vkAccountId, segmentId])
  @@map("segment_labels")
}

// Пользовательские названия для интересов VK
model InterestLabel {
  id              Int            @id @default(autoincrement())
  vkAccountId     Int            @map("vk_account_id")
  interestId      Int            @map("interest_id")  // ID интереса в VK
  name            String         // Пользовательское название
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@unique([vkAccountId, interestId])
  @@map("interest_labels")
}

// Папки для организации креативов
model CreativeFolder {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  name            String
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  creatives       Creative[]

  @@map("creative_folders")
}

// Креативы (изображения/видео) для автозалива
model Creative {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  folderId        Int?           @map("folder_id")

  // Информация о файле
  filename        String         // Оригинальное имя файла
  storagePath     String         @map("storage_path") // Путь к файлу на сервере
  mimeType        String         @map("mime_type") // image/jpeg, video/mp4 и т.д.
  fileSize        Int            @map("file_size") // Размер в байтах
  width           Int?           // Ширина (для изображений/видео)
  height          Int?           // Высота (для изображений/видео)

  // Метаданные
  name            String?        // Пользовательское название
  description     String?        // Описание

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  folder          CreativeFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@map("creatives")
}

// Кэш загруженных креативов в VK Ads
// Предотвращает повторную загрузку одного и того же креатива
model VkCreativeCache {
  id              Int            @id @default(autoincrement())
  libraryCreativeId Int          @map("library_creative_id")  // ID креатива в нашей библиотеке
  vkAccountId     Int            @map("vk_account_id")        // ID VK аккаунта
  vkContentId     Int            @map("vk_content_id")        // ID контента в VK Ads
  contentKey      String         @map("content_key")          // Тип контента (icon_256x256, image_600x600)
  createdAt       DateTime       @default(now()) @map("created_at")

  @@unique([libraryCreativeId, vkAccountId, contentKey])  // Один креатив может быть загружен в разных размерах
  @@map("vk_creative_cache")
}

// Задачи ручного масштабирования групп объявлений
model ScalingTask {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  vkAccountId     Int            @map("vk_account_id")

  // Исходная группа объявлений
  sourceAdGroupId BigInt         @map("source_ad_group_id")
  sourceAdGroupName String?      @map("source_ad_group_name")

  // Количество копий для создания
  copiesCount     Int            @map("copies_count")

  // Созданные копии (массив ID)
  createdCopies   Json?          @map("created_copies") // [{ id: number, name: string }]

  // Статус задачи
  status          String         @default("pending") // pending, running, completed, failed
  progress        Int            @default(0) // Прогресс в процентах
  copiesCreated   Int            @default(0) @map("copies_created")

  errorMessage    String?        @map("error_message")

  createdAt       DateTime       @default(now()) @map("created_at")
  startedAt       DateTime?      @map("started_at")
  completedAt     DateTime?      @map("completed_at")

  @@map("scaling_tasks")
}
